<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOOMIN Digital Hub</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/inter-ui/3.19.3/inter.css" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTU9PTUlOIERpZ2l0YWwgSHViIiwic2hvcnRfbmFtZSI6Ik1PT01JTiBIdWIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA5MDkwYiIsInRoZW1lX2NvbG9yIjoiIzIxMjEzNCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIweG1sbnMlM0QlMjdodHRwJTNBJTJGJTJGd3d3LnczLm9yZyUyRjIwMDAlMkZzdmclMjclMjB2aWV3Qm94JTNEJTI3MCUyMDAlMjAxMDAlMjAxMDAlMjclM0UlM0NyZWN0JTIwd2lkdGglM0QlMjcxMDAlMjclMjBoZWlnaHQlM0QlMjcxMDAlMjclMjBmaWxsJTNEJTI3JTIzMjEyMTM0JTI3JTIwcnglM0QlMjcxNiUyNyUyRiUzRSUzQ3RleHQlMjB4JTNEJTI3NTAlMjclMjB5JTNEJTI3NjAlMjclMjB0ZXh0LWFuY2hvciUzRCUyN21pZGRsZSUyNyUyMGZpbGwlM0QlMjclMjNmZmZmZmYlMjclMjBmb250LXNpemUlM0QlMjc0MCUyNyUyMGZvbnQtZmFtaWx5JTNEJTI3SW50ZXIlMkMlMjBzYW5zLXNlcmlmJTI3JTNFTSUzQyUyRnRleHQlM0UlM0MlMkZzdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <style>
    /* ======================
       DESIGN SYSTEM - FOUNDATION
       ====================== */
    
    :root {
      /* Colors - Professional, coherent palette */
      --gray-50: #fafafa;
      --gray-100: #f4f4f5;
      --gray-200: #e4e4e7;
      --gray-300: #d4d4d8;
      --gray-400: #a1a1aa;
      --gray-500: #71717a;
      --gray-600: #52525b;
      --gray-700: #3f3f46;
      --gray-800: #27272a;
      --gray-900: #18181b;
      --gray-950: #09090b;
      
      --blue-50: #eff6ff;
      --blue-100: #dbeafe;
      --blue-500: #3b82f6;
      --blue-600: #2563eb;
      --blue-700: #1d4ed8;
      
      --green-50: #f0fdf4;
      --green-500: #22c55e;
      --green-600: #16a34a;
      
      --red-50: #fef2f2;
      --red-500: #ef4444;
      --red-600: #dc2626;
      
      --amber-50: #fffbeb;
      --amber-500: #f59e0b;
      --amber-600: #d97706;
      
      --purple-50: #faf5ff;
      --purple-500: #a855f7;
      --purple-600: #9333ea;
      
      /* Light Theme */
      --bg-primary: var(--gray-50);
      --bg-secondary: #ffffff;
      --bg-tertiary: var(--gray-100);
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-600);
      --text-muted: var(--gray-500);
      --border-primary: var(--gray-200);
      --border-secondary: var(--gray-300);
      --accent-primary: var(--blue-600);
      --accent-secondary: var(--purple-600);
      --surface-elevated: #ffffff;
      --backdrop: rgba(0, 0, 0, 0.5);
      
      /* Spacing - 4px baseline grid */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;
      --space-20: 5rem;
      
      /* Typography */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      --line-height-tight: 1.25;
      --line-height-snug: 1.375;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.625;
      
      /* Radius */
      --radius-sm: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-2xl: 1rem;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Layout */
      --sidebar-width: 280px;
      --header-height: 64px;
    }
    
    /* Dark Theme */
    [data-theme="dark"] {
      --bg-primary: var(--gray-950);
      --bg-secondary: var(--gray-900);
      --bg-tertiary: var(--gray-800);
      --text-primary: var(--gray-50);
      --text-secondary: var(--gray-400);
      --text-muted: var(--gray-500);
      --border-primary: var(--gray-800);
      --border-secondary: var(--gray-700);
      --surface-elevated: var(--gray-900);
      --backdrop: rgba(0, 0, 0, 0.8);
    }
    
    /* ======================
       BASE STYLES
       ====================== */
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      font-size: 16px;
    }
    
    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-normal);
      line-height: var(--line-height-normal);
      color: var(--text-primary);
      background-color: var(--bg-primary);
      transition: background-color var(--transition-normal), color var(--transition-normal);
      overflow-x: hidden;
    }
    
    /* Focus styles */
    *:focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    /* Skip to content */
    .skip-to-content {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--accent-primary);
      color: white;
      padding: 8px;
      border-radius: var(--radius-md);
      text-decoration: none;
      transition: top var(--transition-fast);
      z-index: 1000;
    }
    
    .skip-to-content:focus {
      top: 6px;
    }
    
    /* ======================
       PASSWORD GATE
       ====================== */
    
    .password-gate {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity var(--transition-normal);
    }
    
    .password-gate.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .gate-container {
      background: var(--surface-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-xl);
      padding: var(--space-8);
      width: 100%;
      max-width: 420px;
      margin: var(--space-4);
    }
    
    .gate-header {
      text-align: center;
      margin-bottom: var(--space-6);
    }
    
    .gate-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }
    
    .gate-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
    
    .gate-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .gate-error {
      background: var(--red-50);
      border: 1px solid var(--red-500);
      color: var(--red-600);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      display: none;
    }
    
    .gate-hint {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      text-align: center;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-color: transparent;
      transition: text-decoration-color var(--transition-fast);
    }
    
    .gate-hint:hover {
      text-decoration-color: var(--text-muted);
    }
    
    /* ======================
       APP LAYOUT
       ====================== */
    
    .app {
      display: none;
      height: 100vh;
      overflow: hidden;
    }
    
    .app.visible {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      grid-template-rows: var(--header-height) 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
    }
    
    /* ======================
       SIDEBAR
       ====================== */
    
    .sidebar {
      grid-area: sidebar;
      background: var(--surface-elevated);
      border-right: 1px solid var(--border-primary);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: transform var(--transition-normal);
    }
    
    .sidebar-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--border-primary);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .logo-image {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-lg);
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
    }
    
    .logo-text {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }
    
    .sidebar-nav {
      flex: 1;
      padding: var(--space-4);
    }
    
    .nav-section {
      margin-bottom: var(--space-6);
    }
    
    .nav-section-title {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-3);
      padding: 0 var(--space-3);
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      text-decoration: none;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      transition: background-color var(--transition-fast), color var(--transition-fast);
      margin-bottom: var(--space-1);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .nav-item.active {
      background: var(--blue-50);
      color: var(--accent-primary);
    }
    
    [data-theme="dark"] .nav-item.active {
      background: var(--gray-800);
    }
    
    .nav-icon {
      font-size: var(--font-size-lg);
      width: 20px;
      text-align: center;
    }
    
    .nav-badge {
      background: var(--accent-primary);
      color: white;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      margin-left: auto;
    }
    
    /* ======================
       HEADER
       ====================== */
    
    .header {
      grid-area: header;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      padding: 0 var(--space-6);
      gap: var(--space-4);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .mobile-menu-button {
      display: none;
    }
    
    .search-container {
      flex: 1;
      max-width: 500px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      padding-left: var(--space-10);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }
    
    .search-shortcut {
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      color: var(--text-muted);
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      pointer-events: none;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .header-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    
    .header-button:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .header-button.active {
      background: var(--blue-50);
      color: var(--accent-primary);
    }
    
    [data-theme="dark"] .header-button.active {
      background: var(--gray-800);
    }
    
    .clock {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }
    
    /* ======================
       MAIN CONTENT
       ====================== */
    
    .main {
      grid-area: main;
      background: var(--bg-primary);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .main-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--border-primary);
      background: var(--surface-elevated);
    }
    
    .page-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin: 0;
    }
    
    .page-description {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
      margin-top: var(--space-2);
    }
    
    .main-content {
      flex: 1;
      padding: var(--space-6);
    }
    
    /* ======================
       COMPONENTS - BUTTONS
       ====================== */
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--blue-700);
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-primary);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-tertiary);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }
    
    .btn-ghost:hover:not(:disabled) {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .btn-danger {
      background: var(--red-500);
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: var(--red-600);
    }
    
    .btn-sm {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
    }
    
    .btn-lg {
      padding: var(--space-4) var(--space-6);
      font-size: var(--font-size-base);
    }
    
    /* ======================
       COMPONENTS - INPUTS
       ====================== */
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .input-label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
    }
    
    .input-label.required::after {
      content: " *";
      color: var(--red-500);
    }
    
    .input {
      padding: var(--space-3);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .input::placeholder {
      color: var(--text-muted);
    }
    
    .textarea {
      resize: vertical;
      min-height: 120px;
      font-family: var(--font-family);
    }
    
    .input-error {
      border-color: var(--red-500);
    }
    
    .input-error:focus {
      box-shadow: 0 0 0 3px rgb(239 68 68 / 0.1);
    }
    
    .error-message {
      font-size: var(--font-size-xs);
      color: var(--red-500);
    }
    
    /* ======================
       COMPONENTS - CARDS
       ====================== */
    
    .card {
      background: var(--surface-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      transition: box-shadow var(--transition-fast), transform var(--transition-fast);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .card-header {
      padding: var(--space-5);
      border-bottom: 1px solid var(--border-primary);
    }
    
    .card-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin: 0;
    }
    
    .card-description {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-2);
    }
    
    .card-body {
      padding: var(--space-5);
    }
    
    .card-footer {
      padding: var(--space-5);
      border-top: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }
    
    .card-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    /* ======================
       COMPONENTS - MODALS
       ====================== */
    
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: var(--backdrop);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
      backdrop-filter: blur(2px);
    }
    
    .modal-backdrop.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--surface-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      z-index: 1001;
      opacity: 0;
      transition: all var(--transition-normal);
      margin: var(--space-4);
    }
    
    .modal-backdrop.visible .modal {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-5);
      border-bottom: 1px solid var(--border-primary);
    }
    
    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin: 0;
    }
    
    .modal-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    
    .modal-close:hover {
      background: var(--border-primary);
      color: var(--text-primary);
    }
    
    .modal-body {
      padding: var(--space-5);
      overflow-y: auto;
      max-height: calc(90vh - 120px);
    }
    
    .modal-footer {
      padding: var(--space-5);
      border-top: 1px solid var(--border-primary);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
    }
    
    /* ======================
       COMPONENTS - TAGS
       ====================== */
    
    .tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-3);
      background: var(--blue-50);
      color: var(--blue-600);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
    }
    
    [data-theme="dark"] .tag {
      background: var(--gray-800);
      color: var(--blue-400);
    }
    
    .tag-purple {
      background: var(--purple-50);
      color: var(--purple-600);
    }
    
    [data-theme="dark"] .tag-purple {
      background: var(--gray-800);
      color: var(--purple-400);
    }
    
    .tag-green {
      background: var(--green-50);
      color: var(--green-600);
    }
    
    [data-theme="dark"] .tag-green {
      background: var(--gray-800);
      color: var(--green-400);
    }
    
    .tag-amber {
      background: var(--amber-50);
      color: var(--amber-600);
    }
    
    [data-theme="dark"] .tag-amber {
      background: var(--gray-800);
      color: var(--amber-400);
    }
    
    /* ======================
       COMPONENTS - TOAST
       ====================== */
    
    .toast-container {
      position: fixed;
      top: var(--space-4);
      right: var(--space-4);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .toast {
      background: var(--surface-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-4);
      max-width: 400px;
      transform: translateX(calc(100% + var(--space-4)));
      transition: transform var(--transition-normal);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .toast.visible {
      transform: translateX(0);
    }
    
    .toast-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-sm);
      flex-shrink: 0;
    }
    
    .toast-success .toast-icon {
      background: var(--green-500);
      color: white;
    }
    
    .toast-error .toast-icon {
      background: var(--red-500);
      color: white;
    }
    
    .toast-info .toast-icon {
      background: var(--blue-500);
      color: white;
    }
    
    .toast-warning .toast-icon {
      background: var(--amber-500);
      color: white;
    }
    
    .toast-message {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
    }
    
    .toast-actions {
      display: flex;
      gap: var(--space-2);
    }
    
    .toast-action {
      background: none;
      border: none;
      color: var(--accent-primary);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-sm);
      transition: background-color var(--transition-fast);
    }
    
    .toast-action:hover {
      background: var(--bg-tertiary);
    }
    
    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-sm);
      transition: color var(--transition-fast), background-color var(--transition-fast);
    }
    
    .toast-close:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }
    
    /* ======================
       COMPONENTS - EMPTY STATES
       ====================== */
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-16) var(--space-4);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }
    
    .empty-state-description {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
      max-width: 400px;
      margin-bottom: var(--space-4);
      line-height: var(--line-height-relaxed);
    }
    
    /* ======================
       COMPONENTS - LOADING
       ====================== */
    
    .skeleton {
      background: var(--bg-tertiary);
      background-image: linear-gradient(
        90deg,
        var(--bg-tertiary) 25%,
        var(--border-primary) 50%,
        var(--bg-tertiary) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-text {
      height: 1em;
      margin-bottom: var(--space-2);
    }
    
    .skeleton-text:last-child {
      margin-bottom: 0;
    }
    
    .skeleton-title {
      height: 1.5em;
      width: 60%;
      margin-bottom: var(--space-3);
    }
    
    .skeleton-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    /* ======================
       COMPONENTS - FAB
       ====================== */
    
    .fab {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      width: 56px;
      height: 56px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: 50%;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      cursor: pointer;
      transition: all var(--transition-fast);
      z-index: 100;
    }
    
    .fab:hover {
      background: var(--blue-700);
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }
    
    .fab:active {
      transform: scale(0.95);
    }
    
    /* ======================
       POMODORO TIMER
       ====================== */
    
    .pomodoro-widget {
      position: relative;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .pomodoro-display {
      font-variant-numeric: tabular-nums;
      font-weight: var(--font-weight-medium);
      color: var(--text-secondary);
    }
    
    .pomodoro-display.active {
      color: var(--accent-primary);
    }
    
    .pomodoro-controls {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--surface-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-4);
      min-width: 200px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all var(--transition-fast);
    }
    
    .pomodoro-controls.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .pomodoro-progress {
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-3);
      overflow: hidden;
    }
    
    .pomodoro-progress-bar {
      height: 100%;
      background: var(--accent-primary);
      border-radius: var(--radius-sm);
      transition: width var(--transition-normal);
    }
    
    /* ======================
       GRID LAYOUTS
       ====================== */
    
    .grid {
      display: grid;
      gap: var(--space-6);
    }
    
    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }
    
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .grid-auto {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
    
    /* ======================
       UTILITIES
       ====================== */
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    .hidden {
      display: none !important;
    }
    
    .flex {
      display: flex;
    }
    
    .flex-col {
      flex-direction: column;
    }
    
    .items-center {
      align-items: center;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    .gap-2 {
      gap: var(--space-2);
    }
    
    .gap-3 {
      gap: var(--space-3);
    }
    
    .gap-4 {
      gap: var(--space-4);
    }
    
    .text-sm {
      font-size: var(--font-size-sm);
    }
    
    .text-muted {
      color: var(--text-muted);
    }
    
    .font-medium {
      font-weight: var(--font-weight-medium);
    }
    
    .font-semibold {
      font-weight: var(--font-weight-semibold);
    }
    
    /* ======================
       RESPONSIVE DESIGN
       ====================== */
    
    @media (max-width: 768px) {
      .app.visible {
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "main";
      }
    
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100%;
        z-index: 999;
        transform: translateX(-100%);
      }
    
      .sidebar.visible {
        transform: translateX(0);
      }
    
      .mobile-menu-button {
        display: block;
      }
    
      .search-container {
        max-width: none;
      }
    
      .search-shortcut {
        display: none;
      }
    
      .header-actions {
        gap: var(--space-1);
      }
    
      .main-header {
        padding: var(--space-4);
      }
    
      .main-content {
        padding: var(--space-4);
      }
    
      .page-title {
        font-size: var(--font-size-2xl);
      }
    
      .modal {
        margin: var(--space-2);
        max-height: calc(100vh - var(--space-4));
      }
    
      .grid-cols-2,
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
    
      .fab {
        bottom: var(--space-4);
        right: var(--space-4);
      }
    
      .toast-container {
        top: var(--space-2);
        right: var(--space-2);
        left: var(--space-2);
      }
    
      .toast {
        max-width: none;
      }
    }
    
    @media (max-width: 480px) {
      .gate-container {
        margin: var(--space-2);
        padding: var(--space-6);
      }
    
      .header {
        padding: 0 var(--space-4);
      }
    
      .sidebar-header {
        padding: var(--space-4);
      }
    
      .logo-text {
        font-size: var(--font-size-base);
      }
    }
  </style>
</head>
<body>
  <!-- Skip to content link -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container" role="region" aria-label="Notifications"></div>

  <!-- Password Gate -->
  <div class="password-gate" id="password-gate">
    <div class="gate-container">
      <div class="gate-header">
        <h1 class="gate-title">Welcome to MOOMIN Digital Hub</h1>
        <p class="gate-subtitle">Enter your password to access your personal workspace</p>
      </div>
      <form class="gate-form" id="password-form">
        <div class="gate-error" id="password-error" role="alert"></div>
        <div class="input-group">
          <label for="password-input" class="input-label">Password</label>
          <input 
            type="password" 
            id="password-input" 
            class="input" 
            placeholder="Enter your password"
            autocomplete="current-password"
            required
          >
        </div>
        <button type="submit" class="btn btn-primary btn-lg">Unlock Hub</button>
      </form>
      <button type="button" class="gate-hint" id="password-hint">Need help with your password?</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-image">M</div>
          <span class="logo-text">MOOMIN Hub</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Workspace</div>
          <button class="nav-item active" data-section="dashboard" aria-current="page">
            <span class="nav-icon">üè†</span>
            <span>Dashboard</span>
          </button>
          <button class="nav-item" data-section="notes">
            <span class="nav-icon">üìù</span>
            <span>Notes</span>
            <span class="nav-badge" id="notes-count">0</span>
          </button>
          <button class="nav-item" data-section="bookmarks">
            <span class="nav-icon">üîñ</span>
            <span>Bookmarks</span>
            <span class="nav-badge" id="bookmarks-count">0</span>
          </button>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Projects</div>
          <button class="nav-item" data-section="arduino">
            <span class="nav-icon">üîß</span>
            <span>Arduino Lab</span>
            <span class="nav-badge" id="arduino-count">0</span>
          </button>
          <button class="nav-item" data-section="gallery">
            <span class="nav-icon">üñºÔ∏è</span>
            <span>Gallery</span>
            <span class="nav-badge" id="gallery-count">0</span>
          </button>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <button class="nav-item" data-section="vault">
            <span class="nav-icon">üíæ</span>
            <span>Vault</span>
          </button>
          <button class="nav-item" data-section="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Settings</span>
          </button>
        </div>
      </nav>
    </aside>

    <!-- Header -->
    <header class="header" role="banner">
      <div class="header-left">
        <button class="header-button mobile-menu-button" id="mobile-menu" aria-label="Open navigation menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        
        <div class="search-container">
          <input 
            type="search" 
            class="search-input" 
            id="global-search" 
            placeholder="Search notes, bookmarks, projects..." 
            aria-label="Search"
          >
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <kbd class="search-shortcut">‚åòK</kbd>
        </div>
      </div>
      
      <div class="header-actions">
        <div class="pomodoro-widget">
          <button class="header-button" id="pomodoro-toggle" aria-label="Pomodoro timer">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
          </button>
          <span class="pomodoro-display" id="pomodoro-display">25:00</span>
          <div class="pomodoro-controls" id="pomodoro-controls">
            <div class="pomodoro-progress">
              <div class="pomodoro-progress-bar" id="pomodoro-progress"></div>
            </div>
            <div class="flex items-center justify-between gap-2">
              <button class="btn btn-sm btn-secondary" id="pomodoro-start">Start</button>
              <button class="btn btn-sm btn-ghost" id="pomodoro-pause" disabled>Pause</button>
              <button class="btn btn-sm btn-ghost" id="pomodoro-reset">Reset</button>
            </div>
          </div>
        </div>
        
        <button class="header-button" id="theme-toggle" aria-label="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        
        <div class="clock" id="clock">12:00 PM</div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main" role="main">
      <div class="main-header">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <p class="page-description" id="page-description">Welcome back to your productivity hub</p>
      </div>
      
      <div class="main-content" id="main-content">
        <!-- Content will be loaded dynamically -->
        <div class="empty-state">
          <div class="empty-state-icon">üöÄ</div>
          <h2 class="empty-state-title">Loading your workspace...</h2>
          <p class="empty-state-description">Setting up your personal productivity hub</p>
        </div>
      </div>
    </main>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" aria-label="Add new item">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </button>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" id="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Modal Title</h2>
        <button class="modal-close" id="modal-close" aria-label="Close modal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Modal content will be inserted here -->
      </div>
      <div class="modal-footer" id="modal-footer" style="display: none;">
        <!-- Modal footer will be inserted here if needed -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // ======================
    // GLOBAL STATE & CONFIG
    // ======================
    
    const APP_CONFIG = {
      name: 'MOOMIN Digital Hub',
      version: '2.0.0',
      dbName: 'moomin_hub_v2',
      dbVersion: 1,
      stores: ['settings', 'notes', 'bookmarks', 'arduino', 'gallery', 'files'],
      defaultPomodoroSettings: {
        workDuration: 25 * 60,
        breakDuration: 5 * 60,
        longBreakDuration: 15 * 60,
        longBreakInterval: 4
      }
    };
    
    class AppState {
      constructor() {
        this.db = null;
        this.currentSection = 'dashboard';
        this.isAuthenticated = false;
        this.theme = 'light';
        this.searchIndex = null;
        this.undoStack = [];
        this.redoStack = [];
        this.pomodoro = {
          isActive: false,
          timeLeft: APP_CONFIG.defaultPomodoroSettings.workDuration,
          isBreak: false,
          session: 0,
          timer: null
        };
        this.folderHandle = null;
        this.toastQueue = [];
        this.activeToasts = new Set();
      }
    }
    
    const app = new AppState();
    let focusTrap = null;
    let urlCleanupSet = new Set();
    
    // ======================
    // INITIALIZATION
    // ======================
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });
    
    async function initializeApp() {
      try {
        await initializeDatabase();
        await loadUserSettings();
        await checkAuthentication();
        setupEventListeners();
        setupServiceWorker();
        updateClock();
        setInterval(updateClock, 60000);
        await loadLinkedFolderOnStartup();
      } catch (error) {
        handleError('Failed to initialize app', error);
      }
    }
    
    // ======================
    // DATABASE MANAGEMENT
    // ======================
    
    function initializeDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(APP_CONFIG.dbName, APP_CONFIG.dbVersion);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          app.db = request.result;
          resolve();
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Create object stores
          APP_CONFIG.stores.forEach(storeName => {
            if (!db.objectStoreNames.contains(storeName)) {
              const store = db.createObjectStore(storeName, { 
                keyPath: 'id', 
                autoIncrement: true 
              });
              
              // Add indexes
              switch (storeName) {
                case 'settings':
                  store.createIndex('key', 'key', { unique: true });
                  break;
                case 'notes':
                  store.createIndex('title', 'title');
                  store.createIndex('createdAt', 'createdAt');
                  store.createIndex('tags', 'tags', { multiEntry: true });
                  break;
                case 'bookmarks':
                  store.createIndex('url', 'url');
                  store.createIndex('title', 'title');
                  store.createIndex('tags', 'tags', { multiEntry: true });
                  break;
              }
            }
          });
        };
      });
    }
    
    // Generic database operations
    function dbGet(storeName, key) {
      return new Promise((resolve, reject) => {
        const tx = app.db.transaction([storeName], 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.get(key);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    function dbGetAll(storeName) {
      return new Promise((resolve, reject) => {
        const tx = app.db.transaction([storeName], 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    function dbAdd(storeName, item) {
      return new Promise((resolve, reject) => {
        const tx = app.db.transaction([storeName], 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.add({
          ...item,
          createdAt: item.createdAt || new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        
        request.onsuccess = () => {
          resolve(request.result);
          updateSearchIndex();
          updateNavigationCounts();
        };
        request.onerror = () => reject(request.error);
      });
    }
    
    function dbUpdate(storeName, item) {
      return new Promise((resolve, reject) => {
        const tx = app.db.transaction([storeName], 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.put({
          ...item,
          updatedAt: new Date().toISOString()
        });
        
        request.onsuccess = () => {
          resolve(request.result);
          updateSearchIndex();
          updateNavigationCounts();
        };
        request.onerror = () => reject(request.error);
      });
    }
    
    function dbDelete(storeName, id) {
      return new Promise((resolve, reject) => {
        const tx = app.db.transaction([storeName], 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.delete(id);
        
        request.onsuccess = () => {
          resolve();
          updateSearchIndex();
          updateNavigationCounts();
        };
        request.onerror = () => reject(request.error);
      });
    }
    
    // Settings helpers
    async function getSetting(key, defaultValue = null) {
      try {
        const tx = app.db.transaction(['settings'], 'readonly');
        const store = tx.objectStore('settings');
        const index = store.index('key');
        const request = index.get(key);
        
        return new Promise((resolve) => {
          request.onsuccess = () => {
            resolve(request.result ? request.result.value : defaultValue);
          };
          request.onerror = () => resolve(defaultValue);
        });
      } catch (error) {
        return defaultValue;
      }
    }
    
    async function setSetting(key, value) {
      try {
        const tx = app.db.transaction(['settings'], 'readwrite');
        const store = tx.objectStore('settings');
        const request = store.put({ key, value, updatedAt: new Date().toISOString() });
        
        return new Promise((resolve, reject) => {
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      } catch (error) {
        throw error;
      }
    }
    
    // ======================
    // AUTHENTICATION
    // ======================
    
    async function checkAuthentication() {
      const passwordHash = await getSetting('passwordHash');
      const passwordSalt = await getSetting('passwordSalt');
      
      if (!passwordHash || !passwordSalt) {
        // Hide password gate and show first-time setup
        document.getElementById('password-gate').style.display = 'none';
        await showFirstTimeSetup();
      } else {
        showPasswordGate();
      }
    }
    
    async function showFirstTimeSetup() {
      const modal = document.getElementById('modal-backdrop');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      const footer = document.getElementById('modal-footer');
      
      title.textContent = 'Welcome to MOOMIN Hub';
      body.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üëã</div>
          <h3 class="empty-state-title">Let's set up your workspace</h3>
          <p class="empty-state-description">Create a password to secure your personal productivity hub</p>
        </div>
        <div class="input-group">
          <label for="setup-password" class="input-label required">Password</label>
          <input type="password" id="setup-password" class="input" placeholder="Create a strong password" minlength="6" required>
        </div>
        <div class="input-group">
          <label for="setup-confirm" class="input-label required">Confirm Password</label>
          <input type="password" id="setup-confirm" class="input" placeholder="Confirm your password" required>
        </div>
        <div class="error-message" id="setup-error" style="display: none;"></div>
      `;
      
      footer.style.display = 'flex';
      footer.innerHTML = `
        <button class="btn btn-primary" id="setup-save">Create Account</button>
      `;
      
      showModal(modal);
      
      document.getElementById('setup-save').addEventListener('click', handleFirstTimeSetup);
      document.getElementById('setup-password').focus();
    }
    
    async function handleFirstTimeSetup() {
      const password = document.getElementById('setup-password').value;
      const confirm = document.getElementById('setup-confirm').value;
      const errorEl = document.getElementById('setup-error');
      
      if (!password || !confirm) {
        showError(errorEl, 'Please fill in both password fields');
        return;
      }
      
      if (password.length < 6) {
        showError(errorEl, 'Password must be at least 6 characters long');
        return;
      }
      
      if (password !== confirm) {
        showError(errorEl, 'Passwords do not match');
        return;
      }
      
      try {
        await savePassword(password);
        hideModal();
        app.isAuthenticated = true;
        
        // Hide password gate and show app
        document.getElementById('password-gate').style.display = 'none';
        document.getElementById('app').classList.add('visible');
        
        // Initialize the app properly
        await updateNavigationCounts();
        await initializeSearch();
        loadSection('dashboard');
        
        showToast('Welcome to MOOMIN Hub! Your workspace is ready.', 'success');
      } catch (error) {
        showError(errorEl, 'Failed to create account. Please try again.');
      }
    }
    
    function showPasswordGate() {
      const gate = document.getElementById('password-gate');
      const appEl = document.getElementById('app');
      
      gate.classList.remove('hidden');
      appEl.classList.remove('visible');
      
      document.getElementById('password-input').focus();
    }
    
    function hidePasswordGate() {
      const gate = document.getElementById('password-gate');
      const appEl = document.getElementById('app');
      
      gate.classList.add('hidden');
      appEl.classList.add('visible');
      
      app.isAuthenticated = true;
      loadSection('dashboard');
    }
    
    async function handlePasswordSubmit(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('password-input');
      const errorEl = document.getElementById('password-error');
      const password = passwordInput.value;
      
      if (!password) {
        showError(errorEl, 'Please enter your password');
        return;
      }
      
      try {
        const isValid = await verifyPassword(password);
        if (isValid) {
          hidePasswordGate();
          showToast('Welcome back to MOOMIN Hub!', 'success');
        } else {
          showError(errorEl, 'Incorrect password. Please try again.');
          passwordInput.value = '';
          passwordInput.focus();
        }
      } catch (error) {
        showError(errorEl, 'Authentication failed. Please try again.');
      }
    }
    
    async function savePassword(password) {
      const salt = generateSalt();
      const hash = await hashPassword(password, salt);
      
      await setSetting('passwordHash', hash);
      await setSetting('passwordSalt', salt);
    }
    
    async function verifyPassword(password) {
      const storedHash = await getSetting('passwordHash');
      const salt = await getSetting('passwordSalt');
      
      if (!storedHash || !salt) return false;
      
      const hash = await hashPassword(password, salt);
      return hash === storedHash;
    }
    
    function generateSalt() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
    }
    
    async function hashPassword(password, salt) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + salt);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // ======================
    // SECTION MANAGEMENT
    // ======================
    
    async function loadSection(sectionName) {
      if (!app.isAuthenticated) return;
      
      app.currentSection = sectionName;
      updateNavigation();
      updatePageHeader(sectionName);
      
      const content = document.getElementById('main-content');
      content.innerHTML = '<div class="skeleton-container"></div>';
      
      try {
        let html = '';
        switch (sectionName) {
          case 'dashboard':
            html = await renderDashboard();
            break;
          case 'notes':
            html = await renderNotes();
            break;
          case 'bookmarks':
            html = await renderBookmarks();
            break;
          case 'arduino':
            html = await renderArduino();
            break;
          case 'gallery':
            html = await renderGallery();
            break;
          case 'vault':
            html = await renderVault();
            break;
          case 'settings':
            html = await renderSettings();
            break;
          default:
            html = renderComingSoon(sectionName);
        }
        
        content.innerHTML = html;
        setupSectionEventListeners(sectionName);
        
      } catch (error) {
        handleError(`Failed to load ${sectionName}`, error);
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h2 class="empty-state-title">Loading Error</h2>
            <p class="empty-state-description">Failed to load this section. Please try again.</p>
            <button class="btn btn-primary" onclick="loadSection('${sectionName}')">Retry</button>
          </div>
        `;
      }
    }
    
    function updateNavigation() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        item.removeAttribute('aria-current');
      });
      
      const activeItem = document.querySelector(`[data-section="${app.currentSection}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        activeItem.setAttribute('aria-current', 'page');
      }
    }
    
    function updatePageHeader(sectionName) {
      const titles = {
        dashboard: { title: 'Dashboard', description: 'Overview of your productivity workspace' },
        notes: { title: 'Notes', description: 'Capture and organize your thoughts' },
        bookmarks: { title: 'Bookmarks', description: 'Save and categorize important links' },
        arduino: { title: 'Arduino Lab', description: 'Document your hardware projects and experiments' },
        gallery: { title: 'Gallery', description: 'Visual memories and project documentation' },
        vault: { title: 'Vault', description: 'Backup and sync your data' },
        settings: { title: 'Settings', description: 'Customize your MOOMIN Hub experience' }
      };
      
      const config = titles[sectionName] || { title: sectionName, description: '' };
      document.getElementById('page-title').textContent = config.title;
      document.getElementById('page-description').textContent = config.description;
    }
    
    async function updateNavigationCounts() {
      try {
        const counts = await Promise.all([
          dbGetAll('notes').then(items => items.length),
          dbGetAll('bookmarks').then(items => items.length),
          dbGetAll('arduino').then(items => items.length),
          dbGetAll('gallery').then(items => items.length)
        ]);
        
        document.getElementById('notes-count').textContent = counts[0];
        document.getElementById('bookmarks-count').textContent = counts[1];
        document.getElementById('arduino-count').textContent = counts[2];
        document.getElementById('gallery-count').textContent = counts[3];
      } catch (error) {
        console.warn('Failed to update navigation counts:', error);
      }
    }
    
    // ======================
    // SECTION RENDERERS
    // ======================
    
    async function renderDashboard() {
      const [notes, bookmarks, arduino, gallery] = await Promise.all([
        dbGetAll('notes'),
        dbGetAll('bookmarks'),
        dbGetAll('arduino'),
        dbGetAll('gallery')
      ]);
      
      const recentNotes = notes.slice(-3).reverse();
      const recentBookmarks = bookmarks.slice(-3).reverse();
      
      const stats = [
        { icon: 'üìù', label: 'Notes', count: notes.length, color: 'blue' },
        { icon: 'üîñ', label: 'Bookmarks', count: bookmarks.length, color: 'purple' },
        { icon: 'üîß', label: 'Arduino Projects', count: arduino.length, color: 'green' },
        { icon: 'üñºÔ∏è', label: 'Gallery Items', count: gallery.length, color: 'amber' }
      ];
      
      return `
        <div class="grid grid-cols-2 md:grid-cols-4 mb-8">
          ${stats.map(stat => `
            <div class="card">
              <div class="card-body text-center">
                <div style="font-size: 2rem; margin-bottom: var(--space-2);">${stat.icon}</div>
                <div style="font-size: 2rem; font-weight: var(--font-weight-bold); color: var(--accent-primary); margin-bottom: var(--space-2);">${stat.count}</div>
                <div class="text-sm text-muted">${stat.label}</div>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Notes</h3>
              <button class="btn btn-sm btn-ghost" onclick="loadSection('notes')">View All</button>
            </div>
            <div class="card-body">
              ${recentNotes.length > 0 ? recentNotes.map(note => `
                <div class="flex items-center justify-between py-3 border-b last:border-b-0" style="border-color: var(--border-primary);">
                  <div class="flex-1">
                    <div class="font-medium text-sm">${escapeHtml(note.title || 'Untitled')}</div>
                    <div class="text-xs text-muted">${formatDate(note.createdAt)}</div>
                  </div>
                  <button class="btn btn-sm btn-ghost" onclick="editNote(${note.id})">Edit</button>
                </div>
              `).join('') : '<div class="text-muted text-sm">No notes yet. Create your first note!</div>'}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Bookmarks</h3>
              <button class="btn btn-sm btn-ghost" onclick="loadSection('bookmarks')">View All</button>
            </div>
            <div class="card-body">
              ${recentBookmarks.length > 0 ? recentBookmarks.map(bookmark => `
                <div class="flex items-center justify-between py-3 border-b last:border-b-0" style="border-color: var(--border-primary);">
                  <div class="flex-1">
                    <div class="font-medium text-sm">${escapeHtml(bookmark.title || bookmark.url)}</div>
                    <div class="text-xs text-muted">${formatDate(bookmark.createdAt)}</div>
                  </div>
                  <a href="${escapeHtml(bookmark.url)}" target="_blank" class="btn btn-sm btn-ghost" rel="noopener noreferrer">Open</a>
                </div>
              `).join('') : '<div class="text-muted text-sm">No bookmarks yet. Save your first link!</div>'}
            </div>
          </div>
        </div>
        
        <div class="card mt-6">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <button class="btn btn-secondary" onclick="openNewNoteModal()">
                üìù New Note
              </button>
              <button class="btn btn-secondary" onclick="openNewBookmarkModal()">
                üîñ Add Bookmark
              </button>
              <button class="btn btn-secondary" onclick="openNewArduinoModal()">
                üîß Arduino Project
              </button>
              <button class="btn btn-secondary" onclick="triggerFileUpload()">
                üì∏ Upload Image
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    async function renderNotes() {
      const notes = await dbGetAll('notes');
      
      if (notes.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <h2 class="empty-state-title">No notes yet</h2>
            <p class="empty-state-description">Start capturing your thoughts and ideas. Create your first note to get started.</p>
            <button class="btn btn-primary" onclick="openNewNoteModal()">Create Your First Note</button>
          </div>
        `;
      }
      
      // Sort notes by last updated
      notes.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
      
      return `
        <div class="grid grid-auto">
          ${notes.map(note => `
            <div class="card" data-id="${note.id}">
              <div class="card-body">
                <h3 class="card-title">${escapeHtml(note.title || 'Untitled')}</h3>
                ${note.content ? `<p class="card-description">${escapeHtml(truncateText(note.content, 150))}</p>` : ''}
                ${note.tags && note.tags.length > 0 ? `
                  <div class="flex flex-wrap gap-2 mt-3">
                    ${note.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                  </div>
                ` : ''}
                <div class="text-xs text-muted mt-4">
                  ${formatDate(note.updatedAt || note.createdAt)}
                </div>
              </div>
              <div class="card-footer">
                <div class="card-actions">
                  <button class="btn btn-sm btn-ghost" onclick="viewNote(${note.id})">View</button>
                  <button class="btn btn-sm btn-ghost" onclick="editNote(${note.id})">Edit</button>
                  <button class="btn btn-sm btn-ghost" onclick="deleteNote(${note.id})">Delete</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    async function renderBookmarks() {
      const bookmarks = await dbGetAll('bookmarks');
      
      if (bookmarks.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üîñ</div>
            <h2 class="empty-state-title">No bookmarks saved</h2>
            <p class="empty-state-description">Save important links and organize them with tags. Never lose track of valuable resources again.</p>
            <button class="btn btn-primary" onclick="openNewBookmarkModal()">Add Your First Bookmark</button>
          </div>
        `;
      }
      
      bookmarks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      return `
        <div class="grid grid-auto">
          ${bookmarks.map(bookmark => `
            <div class="card" data-id="${bookmark.id}">
              <div class="card-body">
                <h3 class="card-title">${escapeHtml(bookmark.title || bookmark.url)}</h3>
                <p class="text-sm text-muted mb-3">${escapeHtml(getDomain(bookmark.url))}</p>
                ${bookmark.description ? `<p class="card-description">${escapeHtml(bookmark.description)}</p>` : ''}
                ${bookmark.tags && bookmark.tags.length > 0 ? `
                  <div class="flex flex-wrap gap-2 mt-3">
                    ${bookmark.tags.map(tag => `<span class="tag tag-purple">${escapeHtml(tag)}</span>`).join('')}
                  </div>
                ` : ''}
                <div class="text-xs text-muted mt-4">
                  ${formatDate(bookmark.createdAt)}
                </div>
              </div>
              <div class="card-footer">
                <div class="card-actions">
                  <a href="${escapeHtml(bookmark.url)}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary">Open</a>
                  <button class="btn btn-sm btn-ghost" onclick="editBookmark(${bookmark.id})">Edit</button>
                  <button class="btn btn-sm btn-ghost" onclick="deleteBookmark(${bookmark.id})">Delete</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    async function renderArduino() {
      const projects = await dbGetAll('arduino');
      
      if (projects.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <h2 class="empty-state-title">No Arduino projects yet</h2>
            <p class="empty-state-description">Document your hardware experiments, code, and circuit diagrams. Keep track of your maker journey.</p>
            <button class="btn btn-primary" onclick="openNewArduinoModal()">Start Your First Project</button>
          </div>
        `;
      }
      
      projects.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
      
      return `
        <div class="grid grid-auto">
          ${projects.map(project => `
            <div class="card" data-id="${project.id}">
              <div class="card-body">
                <h3 class="card-title">${escapeHtml(project.title || 'Untitled Project')}</h3>
                ${project.description ? `<p class="card-description">${escapeHtml(project.description)}</p>` : ''}
                ${project.status ? `
                  <span class="tag tag-${getStatusColor(project.status)} mt-3">${escapeHtml(project.status)}</span>
                ` : ''}
                ${project.tags && project.tags.length > 0 ? `
                  <div class="flex flex-wrap gap-2 mt-3">
                    ${project.tags.map(tag => `<span class="tag tag-green">${escapeHtml(tag)}</span>`).join('')}
                  </div>
                ` : ''}
                <div class="text-xs text-muted mt-4">
                  ${formatDate(project.updatedAt || project.createdAt)}
                </div>
              </div>
              <div class="card-footer">
                <div class="card-actions">
                  <button class="btn btn-sm btn-ghost" onclick="viewArduinoProject(${project.id})">View</button>
                  <button class="btn btn-sm btn-ghost" onclick="editArduinoProject(${project.id})">Edit</button>
                  <button class="btn btn-sm btn-ghost" onclick="deleteArduinoProject(${project.id})">Delete</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    async function renderGallery() {
      const images = await dbGetAll('gallery');
      
      if (images.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üñºÔ∏è</div>
            <h2 class="empty-state-title">No images in gallery</h2>
            <p class="empty-state-description">Upload photos, screenshots, and visual documentation. Organize your visual memories.</p>
            <button class="btn btn-primary" onclick="triggerFileUpload()">Upload Your First Image</button>
          </div>
        `;
      }
      
      images.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      return `
        <div class="grid grid-auto">
          ${images.map(image => `
            <div class="card" data-id="${image.id}">
              <div class="relative">
                <img 
                  src="${image.dataUrl}" 
                  alt="${escapeHtml(image.title || image.filename)}"
                  class="w-full h-48 object-cover rounded-t-xl cursor-pointer"
                  onclick="openLightbox(${image.id})"
                  loading="lazy"
                >
              </div>
              <div class="card-body">
                <h3 class="card-title">${escapeHtml(image.title || image.filename)}</h3>
                ${image.description ? `<p class="card-description">${escapeHtml(image.description)}</p>` : ''}
                <div class="text-xs text-muted mt-3">
                  ${formatDate(image.createdAt)}
                </div>
              </div>
              <div class="card-footer">
                <div class="card-actions">
                  <button class="btn btn-sm btn-ghost" onclick="openLightbox(${image.id})">View</button>
                  <button class="btn btn-sm btn-ghost" onclick="editImage(${image.id})">Edit</button>
                  <button class="btn btn-sm btn-ghost" onclick="deleteImage(${image.id})">Delete</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderVault() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Export Data</h3>
              <p class="card-description">Create backups of your entire workspace</p>
            </div>
            <div class="card-body">
              <div class="grid gap-3">
                <button class="btn btn-secondary" onclick="exportData('json')">
                  üìÑ Export as JSON
                </button>
                <button class="btn btn-secondary" onclick="exportData('zip')">
                  üì¶ Export as ZIP Archive
                </button>
                <button class="btn btn-secondary" onclick="testSingleImageExport()">
  üß™ Test Export One Image
</button>
                <button class="btn btn-secondary" onclick="exportData('encrypted')">
                  üîí Export Encrypted Backup
                </button>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Import Data</h3>
              <p class="card-description">Restore from previous backups</p>
            </div>
            <div class="card-body">
              <input type="file" id="import-file" accept=".json,.zip" class="input mb-4">
              <button class="btn btn-primary w-full" onclick="importData()">
                üì• Import Backup
              </button>
            </div>
          </div>
        </div>
        
        <div class="card mt-6">
          <div class="card-header">
            <h3 class="card-title">Local Folder Sync</h3>
            <p class="card-description">Link a local folder for automatic backup (Chrome/Edge only)</p>
          </div>
          <div class="card-body">
            <div id="folder-status" class="mb-4 p-4 rounded-lg bg-gray-50">
              <div class="font-medium">Status: Not linked</div>
              <div class="text-sm text-muted">Link a folder to enable automatic backup</div>
            </div>
            <button class="btn btn-primary" onclick="linkLocalFolder()">
              üìÅ Link Local Folder
            </button>
          </div>
        </div>
      `;
    }
    
    function renderSettings() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Security</h3>
            </div>
            <div class="card-body">
              <button class="btn btn-secondary mb-4 w-full" onclick="changePassword()">
                üîë Change Password
              </button>
              <div class="text-sm text-muted">
                Your data is encrypted locally. Keep your password safe - if lost, data cannot be recovered.
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Preferences</h3>
            </div>
            <div class="card-body">
              <div class="input-group mb-4">
                <label class="input-label">Theme</label>
                <select class="input" id="theme-select" onchange="setTheme(this.value)">
                  <option value="light">Light Mode</option>
                  <option value="dark">Dark Mode</option>
                </select>
              </div>
              
              <div class="input-group">
                <label class="input-label">Pomodoro Work Duration (minutes)</label>
                <input type="number" class="input" id="pomodoro-work" min="1" max="60" value="25" onchange="updatePomodoroSettings()">
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mt-6">
          <div class="card-header">
            <h3 class="card-title">About</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
              <div>
                <div class="font-semibold">Version</div>
                <div class="text-muted">${APP_CONFIG.version}</div>
              </div>
              <div>
                <div class="font-semibold">Storage</div>
                <div class="text-muted">Local IndexedDB</div>
              </div>
              <div>
                <div class="font-semibold">Privacy</div>
                <div class="text-muted">100% Local</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderComingSoon(sectionName) {
      return `
        <div class="empty-state">
          <div class="empty-state-icon">üöß</div>
          <h2 class="empty-state-title">Coming Soon</h2>
          <p class="empty-state-description">The ${sectionName} section is planned for a future release. Stay tuned for updates!</p>
        </div>
      `;
    }
    
    // ======================
    // EVENT LISTENERS & SETUP
    // ======================
    
    function setupEventListeners() {
      // Password gate
      const passwordForm = document.getElementById('password-form');
      passwordForm.addEventListener('submit', handlePasswordSubmit);
      
      const passwordHint = document.getElementById('password-hint');
      passwordHint.addEventListener('click', () => {
        showToast('Hint: This is the password you created when setting up MOOMIN Hub. If forgotten, your data cannot be recovered.', 'info');
      });
      
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const section = e.currentTarget.dataset.section;
          if (section) {
            loadSection(section);
            if (window.innerWidth <= 768) {
              hideMobileMenu();
            }
          }
        });
      });
      
      // Mobile menu
      const mobileMenuBtn = document.getElementById('mobile-menu');
      mobileMenuBtn.addEventListener('click', toggleMobileMenu);
      
      // Search
      const searchInput = document.getElementById('global-search');
      searchInput.addEventListener('input', debounce(handleSearch, 300));
      
      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.addEventListener('click', toggleTheme);
      
      // Pomodoro
      const pomodoroToggle = document.getElementById('pomodoro-toggle');
      pomodoroToggle.addEventListener('click', togglePomodoroPanel);
      
      const pomodoroStart = document.getElementById('pomodoro-start');
      const pomodoroPause = document.getElementById('pomodoro-pause');
      const pomodoroReset = document.getElementById('pomodoro-reset');
      
      pomodoroStart.addEventListener('click', startPomodoro);
      pomodoroPause.addEventListener('click', pausePomodoro);
      pomodoroReset.addEventListener('click', resetPomodoro);
      
      // FAB
      const fab = document.getElementById('fab');
      fab.addEventListener('click', handleFabClick);
      
      // Modal
      const modalBackdrop = document.getElementById('modal-backdrop');
      const modalClose = document.getElementById('modal-close');
      
      modalClose.addEventListener('click', hideModal);
      modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
          hideModal();
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
      
      // Cleanup URLs on page unload
      window.addEventListener('beforeunload', cleanupUrls);
      
      // Service worker messages
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);
      }
    }
    
    function setupSectionEventListeners(sectionName) {
      // Section-specific event listeners will be added here
      // as we implement each section's functionality
      
      switch (sectionName) {
        case 'settings':
          setupSettingsListeners();
          break;
        case 'vault':
          setupVaultListeners();
          break;
      }
    }
    
    function setupSettingsListeners() {
      const themeSelect = document.getElementById('theme-select');
      if (themeSelect) {
        themeSelect.value = app.theme;
      }
      
      const pomodoroWork = document.getElementById('pomodoro-work');
      if (pomodoroWork) {
        getSetting('pomodoroWorkDuration', APP_CONFIG.defaultPomodoroSettings.workDuration / 60)
          .then(duration => {
            pomodoroWork.value = duration;
          });
      }
    }
    
    function setupVaultListeners() {
      // Vault-specific listeners will be added when implementing export/import
    }
    
    // ======================
    // UI INTERACTIONS
    // ======================
    
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('visible');
    }
    
    function hideMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.remove('visible');
    }
    
    function handleFabClick() {
      switch (app.currentSection) {
        case 'notes':
          openNewNoteModal();
          break;
        case 'bookmarks':
          openNewBookmarkModal();
          break;
        case 'arduino':
          openNewArduinoModal();
          break;
        case 'gallery':
          triggerFileUpload();
          break;
        default:
          showToast('Quick add not available for this section', 'info');
      }
    }
    
    function handleKeyboardShortcuts(e) {
      // Global shortcuts
      if ((e.ctrlKey || e.metaKey)) {
        switch (e.key) {
          case 'k':
            e.preventDefault();
            document.getElementById('global-search').focus();
            break;
          case 's':
            e.preventDefault();
            // Save current item if applicable
            document.dispatchEvent(new CustomEvent('saveShortcut'));
            break;
          case 'n':
            if (app.currentSection === 'notes') {
              e.preventDefault();
              openNewNoteModal();
            }
            break;
        }
      }
      
      // Escape key
      if (e.key === 'Escape') {
        const modalBackdrop = document.getElementById('modal-backdrop');
        if (modalBackdrop.classList.contains('visible')) {
          hideModal();
        }
        
        const pomodoroControls = document.getElementById('pomodoro-controls');
        if (pomodoroControls.classList.contains('visible')) {
          pomodoroControls.classList.remove('visible');
        }
        
        if (window.innerWidth <= 768) {
          hideMobileMenu();
        }
      }
    }
    
    // ======================
    // MODAL MANAGEMENT
    // ======================
    
    function showModal(backdrop = null) {
      const modalBackdrop = backdrop || document.getElementById('modal-backdrop');
      modalBackdrop.classList.add('visible');
      
      // Focus trap
      const modal = document.getElementById('modal');
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusableElements.length > 0) {
        focusableElements[0].focus();
      }
      
      // Store current focus to return to later
      focusTrap = {
        previousFocus: document.activeElement,
        elements: Array.from(focusableElements)
      };
    }
    
    function hideModal() {
      const modalBackdrop = document.getElementById('modal-backdrop');
      modalBackdrop.classList.remove('visible');
      
      // Clear modal content after animation
      setTimeout(() => {
        document.getElementById('modal-body').innerHTML = '';
        document.getElementById('modal-footer').style.display = 'none';
        document.getElementById('modal-footer').innerHTML = '';
      }, 300);
      
      // Return focus
      if (focusTrap && focusTrap.previousFocus) {
        focusTrap.previousFocus.focus();
        focusTrap = null;
      }
    }
    
    // ======================
    // MODAL FORMS
    // ======================
    
    function openNewNoteModal() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      const footer = document.getElementById('modal-footer');
      
      title.textContent = 'Create New Note';
      body.innerHTML = `
        <form id="note-form">
          <div class="input-group">
            <label for="note-title" class="input-label">Title</label>
            <input type="text" id="note-title" class="input" placeholder="Enter note title">
          </div>
          <div class="input-group">
            <label for="note-content" class="input-label">Content</label>
            <textarea id="note-content" class="input textarea" placeholder="Write your note here..." rows="8"></textarea>
          </div>
          <div class="input-group">
            <label for="note-tags" class="input-label">Tags</label>
            <input type="text" id="note-tags" class="input" placeholder="Enter tags separated by commas">
          </div>
        </form>
      `;
      
      footer.style.display = 'flex';
      footer.innerHTML = `
        <button class="btn btn-ghost" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
      `;
      
      showModal();
      document.getElementById('note-title').focus();
    }
    
    function openNewBookmarkModal() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      const footer = document.getElementById('modal-footer');
      
      title.textContent = 'Add New Bookmark';
      body.innerHTML = `
        <form id="bookmark-form">
          <div class="input-group">
            <label for="bookmark-url" class="input-label required">URL</label>
            <input type="url" id="bookmark-url" class="input" placeholder="https://example.com" required>
          </div>
          <div class="input-group">
            <label for="bookmark-title" class="input-label">Title</label>
            <input type="text" id="bookmark-title" class="input" placeholder="Enter bookmark title">
          </div>
          <div class="input-group">
            <label for="bookmark-description" class="input-label">Description</label>
            <textarea id="bookmark-description" class="input textarea" placeholder="Brief description of this bookmark" rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="bookmark-tags" class="input-label">Tags</label>
            <input type="text" id="bookmark-tags" class="input" placeholder="Enter tags separated by commas">
          </div>
        </form>
      `;
      
      footer.style.display = 'flex';
      footer.innerHTML = `
        <button class="btn btn-ghost" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBookmark()">Save Bookmark</button>
      `;
      
      showModal();
      document.getElementById('bookmark-url').focus();
    }
    
    function openNewArduinoModal() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      const footer = document.getElementById('modal-footer');
      
      title.textContent = 'Create Arduino Project';
      body.innerHTML = `
        <form id="arduino-form">
          <div class="input-group">
            <label for="arduino-title" class="input-label required">Project Title</label>
            <input type="text" id="arduino-title" class="input" placeholder="Enter project title" required>
          </div>
          <div class="input-group">
            <label for="arduino-description" class="input-label">Description</label>
            <textarea id="arduino-description" class="input textarea" placeholder="Describe your project..." rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="arduino-code" class="input-label">Arduino Code</label>
            <textarea id="arduino-code" class="input textarea" placeholder="// Your Arduino code here..." rows="8" style="font-family: monospace;"></textarea>
          </div>
          <div class="input-group">
            <label for="arduino-status" class="input-label">Status</label>
            <select id="arduino-status" class="input">
              <option value="planning">Planning</option>
              <option value="in-progress" selected>In Progress</option>
              <option value="testing">Testing</option>
              <option value="completed">Completed</option>
              <option value="on-hold">On Hold</option>
            </select>
          </div>
          <div class="input-group">
            <label for="arduino-tags" class="input-label">Tags</label>
            <input type="text" id="arduino-tags" class="input" placeholder="sensor, led, motor, etc.">
          </div>
        </form>
      `;
      
      footer.style.display = 'flex';
      footer.innerHTML = `
        <button class="btn btn-ghost" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveArduinoProject()">Save Project</button>
      `;
      
      showModal();
      document.getElementById('arduino-title').focus();
    }
    
    // ======================
    // SAVE FUNCTIONS
    // ======================
    
    async function saveNote() {
      const title = document.getElementById('note-title').value.trim();
      const content = document.getElementById('note-content').value.trim();
      const tags = document.getElementById('note-tags').value.trim();
      
      if (!content) {
        showToast('Please enter some content for your note', 'error');
        return;
      }
      
      try {
        const note = {
          title: title || 'Untitled',
          content,
          tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
          wordCount: content.split(/\s+/).length,
          characterCount: content.length
        };
        
        await dbAdd('notes', note);
        hideModal();
        showToast('Note saved successfully!', 'success');
        
        if (app.currentSection === 'notes') {
          loadSection('notes');
        }
        
      } catch (error) {
        handleError('Failed to save note', error);
      }
    }
    
    async function saveBookmark() {
      const url = document.getElementById('bookmark-url').value.trim();
      const title = document.getElementById('bookmark-title').value.trim();
      const description = document.getElementById('bookmark-description').value.trim();
      const tags = document.getElementById('bookmark-tags').value.trim();
      
      if (!url) {
        showToast('Please enter a URL', 'error');
        return;
      }
      
      try {
        // Validate URL
        new URL(url);
        
        const bookmark = {
          url,
          title: title || getDomain(url),
          description,
          tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
          domain: getDomain(url)
        };
        
        await dbAdd('bookmarks', bookmark);
        hideModal();
        showToast('Bookmark saved successfully!', 'success');
        
        if (app.currentSection === 'bookmarks') {
          loadSection('bookmarks');
        }
        
      } catch (error) {
        if (error.name === 'TypeError') {
          showToast('Please enter a valid URL', 'error');
        } else {
          handleError('Failed to save bookmark', error);
        }
      }
    }
    
    async function saveArduinoProject() {
      const title = document.getElementById('arduino-title').value.trim();
      const description = document.getElementById('arduino-description').value.trim();
      const code = document.getElementById('arduino-code').value.trim();
      const status = document.getElementById('arduino-status').value;
      const tags = document.getElementById('arduino-tags').value.trim();
      
      if (!title) {
        showToast('Please enter a project title', 'error');
        return;
      }
      
      try {
        const project = {
          title,
          description,
          code,
          status,
          tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
          codeLines: code ? code.split('\n').length : 0
        };
        
        await dbAdd('arduino', project);
        hideModal();
        showToast('Arduino project saved successfully!', 'success');
        
        if (app.currentSection === 'arduino') {
          loadSection('arduino');
        }
        
      } catch (error) {
        handleError('Failed to save Arduino project', error);
      }
    }
    
    // ======================
    // SEARCH FUNCTIONALITY
    // ======================
    
    async function initializeSearch() {
      try {
        const [notes, bookmarks, arduino] = await Promise.all([
          dbGetAll('notes'),
          dbGetAll('bookmarks'),
          dbGetAll('arduino')
        ]);
        
        const searchData = [
          ...notes.map(item => ({ ...item, type: 'note', section: 'notes' })),
          ...bookmarks.map(item => ({ ...item, type: 'bookmark', section: 'bookmarks' })),
          ...arduino.map(item => ({ ...item, type: 'arduino', section: 'arduino' }))
        ];
        
        app.searchIndex = new Fuse(searchData, {
          keys: [
            { name: 'title', weight: 0.4 },
            { name: 'content', weight: 0.3 },
            { name: 'description', weight: 0.2 },
            { name: 'tags', weight: 0.1 }
          ],
          threshold: 0.3,
          includeScore: true,
          includeMatches: true
        });
        
      } catch (error) {
        console.warn('Failed to initialize search:', error);
      }
    }
    
    function handleSearch(event) {
      const query = event.target.value.trim();
      
      if (!query || !app.searchIndex) {
        hideSearchResults();
        return;
      }
      
      const results = app.searchIndex.search(query);
      showSearchResults(results, query);
    }
    
    function showSearchResults(results, query) {
      // This would show search results in a dropdown or dedicated area
      // For now, we'll just log the results
      console.log('Search results for:', query, results);
    }
    
    function hideSearchResults() {
      // Hide search results UI
    }
    
    async function updateSearchIndex() {
      await initializeSearch();
    }
    
    // ======================
    // THEME MANAGEMENT
    // ======================
    
    async function loadUserSettings() {
      try {
        const savedTheme = await getSetting('theme', 'light');
        setTheme(savedTheme, false);
        
        const pomodoroSettings = await getSetting('pomodoroSettings', APP_CONFIG.defaultPomodoroSettings);
        Object.assign(app.pomodoro, pomodoroSettings);
        
      } catch (error) {
        console.warn('Failed to load user settings:', error);
      }
    }
    
    async function toggleTheme() {
      const newTheme = app.theme === 'light' ? 'dark' : 'light';
      await setTheme(newTheme, true);
    }
    
    async function setTheme(theme, save = true) {
      app.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      
      const themeButton = document.getElementById('theme-toggle');
      if (theme === 'dark') {
        themeButton.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
        `;
        themeButton.setAttribute('aria-label', 'Switch to light theme');
      } else {
        themeButton.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        `;
        themeButton.setAttribute('aria-label', 'Switch to dark theme');
      }
      
      if (save) {
        try {
          await setSetting('theme', theme);
          showToast(`Switched to ${theme} theme`, 'success');
        } catch (error) {
          console.warn('Failed to save theme preference:', error);
        }
      }
    }
    
    // ======================
    // POMODORO TIMER
    // ======================
    
    function togglePomodoroPanel() {
      const controls = document.getElementById('pomodoro-controls');
      controls.classList.toggle('visible');
    }
    
    function startPomodoro() {
      if (app.pomodoro.isActive) return;
      
      app.pomodoro.isActive = true;
      document.getElementById('pomodoro-start').disabled = true;
      document.getElementById('pomodoro-pause').disabled = false;
      
      app.pomodoro.timer = setInterval(() => {
        app.pomodoro.timeLeft--;
        updatePomodoroDisplay();
        
        if (app.pomodoro.timeLeft <= 0) {
          finishPomodoroSession();
        }
      }, 1000);
      
      updatePomodoroDisplay();
      showToast('Pomodoro session started!', 'success');
    }
    
    function pausePomodoro() {
      if (!app.pomodoro.isActive) return;
      
      app.pomodoro.isActive = false;
      clearInterval(app.pomodoro.timer);
      
      document.getElementById('pomodoro-start').disabled = false;
      document.getElementById('pomodoro-pause').disabled = true;
      
      showToast('Pomodoro paused', 'info');
    }
    
    function resetPomodoro() {
      app.pomodoro.isActive = false;
      clearInterval(app.pomodoro.timer);
      
      app.pomodoro.timeLeft = APP_CONFIG.defaultPomodoroSettings.workDuration;
      app.pomodoro.isBreak = false;
      app.pomodoro.session = 0;
      
      document.getElementById('pomodoro-start').disabled = false;
      document.getElementById('pomodoro-pause').disabled = true;
      
      updatePomodoroDisplay();
      showToast('Pomodoro reset', 'info');
    }
    
    function finishPomodoroSession() {
      clearInterval(app.pomodoro.timer);
      app.pomodoro.isActive = false;
      
      if (!app.pomodoro.isBreak) {
        // Work session finished, start break
        app.pomodoro.session++;
        app.pomodoro.isBreak = true;
        
        if (app.pomodoro.session % APP_CONFIG.defaultPomodoroSettings.longBreakInterval === 0) {
          app.pomodoro.timeLeft = APP_CONFIG.defaultPomodoroSettings.longBreakDuration;
          showNotification('Long break time!', 'Take a 15 minute break. You\'ve earned it!');
        } else {
          app.pomodoro.timeLeft = APP_CONFIG.defaultPomodoroSettings.breakDuration;
          showNotification('Break time!', 'Take a 5 minute break.');
        }
      } else {
        // Break finished, start work
        app.pomodoro.isBreak = false;
        app.pomodoro.timeLeft = APP_CONFIG.defaultPomodoroSettings.workDuration;
        showNotification('Back to work!', 'Break time is over. Ready for another session?');
      }
      
      document.getElementById('pomodoro-start').disabled = false;
      document.getElementById('pomodoro-pause').disabled = true;
      
      updatePomodoroDisplay();
    }
    
    function updatePomodoroDisplay() {
      const minutes = Math.floor(app.pomodoro.timeLeft / 60);
      const seconds = app.pomodoro.timeLeft % 60;
      const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('pomodoro-display').textContent = display;
      
      const progressBar = document.getElementById('pomodoro-progress');
      const totalTime = app.pomodoro.isBreak 
        ? (app.pomodoro.session % APP_CONFIG.defaultPomodoroSettings.longBreakInterval === 0 
           ? APP_CONFIG.defaultPomodoroSettings.longBreakDuration 
           : APP_CONFIG.defaultPomodoroSettings.breakDuration)
        : APP_CONFIG.defaultPomodoroSettings.workDuration;
      
      const progress = ((totalTime - app.pomodoro.timeLeft) / totalTime) * 100;
      progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
      
      // Update display styling
      const displayEl = document.getElementById('pomodoro-display');
      if (app.pomodoro.isActive) {
        displayEl.classList.add('active');
      } else {
        displayEl.classList.remove('active');
      }
    }
    
    // ======================
    // NOTIFICATIONS
    // ======================
    
    async function showNotification(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
          body,
          icon: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23213134\' rx=\'16\'/%3E%3Ctext x=\'50\' y=\'60\' text-anchor=\'middle\' fill=\'%23ffffff\' font-size=\'40\' font-family=\'Inter, sans-serif\'%3EM%3C/text%3E%3C/svg%3E'
        });
      } else if ('Notification' in window && Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          showNotification(title, body);
        }
      } else {
        showToast(`${title}: ${body}`, 'info');
      }
    }
    
    // ======================
    // TOAST NOTIFICATIONS
    // ======================
    
    function showToast(message, type = 'info', action = null) {
      const toastContainer = document.getElementById('toast-container');
      const toastId = Date.now().toString();
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.id = `toast-${toastId}`;
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-message">${escapeHtml(message)}</div>
        ${action ? `<div class="toast-actions"><button class="toast-action">${action.text}</button></div>` : ''}
        <button class="toast-close" aria-label="Close notification">√ó</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Show with animation
      setTimeout(() => toast.classList.add('visible'), 100);
      
      // Event listeners
      const closeBtn = toast.querySelector('.toast-close');
      closeBtn.addEventListener('click', () => hideToast(toastId));
      
      if (action) {
        const actionBtn = toast.querySelector('.toast-action');
        actionBtn.addEventListener('click', () => {
          action.callback();
          hideToast(toastId);
        });
      }
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => hideToast(toastId), 5000);
      
      app.activeToasts.add(toastId);
    }
    
    function hideToast(toastId) {
      const toast = document.getElementById(`toast-${toastId}`);
      if (toast) {
        toast.classList.remove('visible');
        setTimeout(() => {
          toast.remove();
          app.activeToasts.delete(toastId);
        }, 300);
      }
    }
    
    // ======================
    // UTILITY FUNCTIONS
    // ======================
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substr(0, maxLength) + '...';
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
      
      return date.toLocaleDateString();
    }
    
    function getDomain(url) {
      try {
        return new URL(url).hostname;
      } catch {
        return url;
      }
    }
    
    function getStatusColor(status) {
      const colors = {
        planning: 'blue',
        'in-progress': 'amber',
        testing: 'purple',
        completed: 'green',
        'on-hold': 'gray'
      };
      return colors[status] || 'blue';
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    function showError(errorElement, message) {
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }
    
    function handleError(message, error) {
      console.error(message, error);
      showToast(`${message}: ${error.message || 'Unknown error'}`, 'error');
    }
    
    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      document.getElementById('clock').textContent = timeString;
    }
    
    function cleanupUrls() {
      urlCleanupSet.forEach(url => {
        URL.revokeObjectURL(url);
      });
      urlCleanupSet.clear();
    }
    
    // ======================
    // FILE HANDLING
    // ======================
    
    function triggerFileUpload() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = 'image/*';
      input.style.display = 'none';
      
      input.addEventListener('change', handleFileUpload);
      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }
    
    async function handleFileUpload(event) {
      const files = Array.from(event.target.files);
      
      if (files.length === 0) return;
      
      showToast(`Uploading ${files.length} image(s)...`, 'info');
      
      try {
        for (const file of files) {
          await processAndSaveImage(file);
        }
        
        showToast(`Successfully uploaded ${files.length} image(s)!`, 'success');
        
        if (app.currentSection === 'gallery') {
          loadSection('gallery');
        }
        
      } catch (error) {
        handleError('Failed to upload images', error);
      }
    }
    
    async function processAndSaveImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const dataUrl = e.target.result;
            urlCleanupSet.add(dataUrl);
            
            const image = {
              filename: file.name,
              title: file.name.replace(/\.[^/.]+$/, ''),
              description: '',
              dataUrl,
              fileSize: file.size,
              mimeType: file.type
            };
            
            await dbAdd('gallery', image);
            resolve();
          } catch (error) {
            reject(error);
          }
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }
    
    // ======================
    // SERVICE WORKER
    // ======================
    
    function setupServiceWorker() {
      if ('serviceWorker' in navigator) {
        const swScript = `
          const CACHE_NAME = 'moomin-hub-v2';
          const STATIC_RESOURCES = [
            '/',
            '/offline.html'
          ];
          
          self.addEventListener('install', (event) => {
            event.waitUntil(
              caches.open(CACHE_NAME).then((cache) => {
                return cache.addAll(STATIC_RESOURCES);
              })
            );
            self.skipWaiting();
          });
          
          self.addEventListener('fetch', (event) => {
            if (event.request.mode === 'navigate') {
              event.respondWith(
                fetch(event.request).catch(() => {
                  return caches.match('/offline.html');
                })
              );
            } else {
              event.respondWith(
                caches.match(event.request).then((response) => {
                  return response || fetch(event.request);
                })
              );
            }
          });
          
          self.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'SKIP_WAITING') {
              self.skipWaiting();
            }
          });
        `;
        
        const blob = new Blob([swScript], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('ServiceWorker registered:', registration.scope);
            
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showToast('App update available', 'info', {
                    text: 'Update',
                    callback: () => {
                      newWorker.postMessage({ type: 'SKIP_WAITING' });
                      window.location.reload();
                    }
                  });
                }
              });
            });
          })
          .catch(error => {
            console.log('ServiceWorker registration failed:', error);
          });
      }
    }
    
    function handleServiceWorkerMessage(event) {
      const { data } = event;
      
      switch (data.type) {
        case 'CACHE_UPDATED':
          showToast('App has been updated and cached for offline use', 'success');
          break;
        case 'OFFLINE':
          showToast('You are currently offline. Some features may be limited.', 'warning');
          break;
        case 'ONLINE':
          showToast('Connection restored!', 'success');
          break;
      }
    }
    
    // ======================
    // CRUD OPERATIONS
    // ======================
    
    async function viewNote(id) {
      try {
        const note = await dbGet('notes', id);
        if (!note) {
          showToast('Note not found', 'error');
          return;
        }
        
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        
        title.textContent = note.title || 'Untitled';
        body.innerHTML = `
          <div class="prose">
            <div class="mb-4">
              ${note.content ? `<div style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(note.content)}</div>` : '<em>No content</em>'}
            </div>
            ${note.tags && note.tags.length > 0 ? `
              <div class="mb-4">
                <strong>Tags:</strong>
                <div class="flex flex-wrap gap-2 mt-2">
                  ${note.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                </div>
              </div>
            ` : ''}
            <div class="text-sm text-muted">
              <div>Created: ${formatDate(note.createdAt)}</div>
              ${note.updatedAt && note.updatedAt !== note.createdAt ? `<div>Updated: ${formatDate(note.updatedAt)}</div>` : ''}
              ${note.wordCount ? `<div>Words: ${note.wordCount}</div>` : ''}
            </div>
          </div>
        `;
        
        showModal();
        
      } catch (error) {
        handleError('Failed to load note', error);
      }
    }
    
    async function editNote(id) {
      try {
        const note = await dbGet('notes', id);
        if (!note) {
          showToast('Note not found', 'error');
          return;
        }
        
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const footer = document.getElementById('modal-footer');
        
        title.textContent = 'Edit Note';
        body.innerHTML = `
          <form id="edit-note-form">
            <div class="input-group">
              <label for="edit-note-title" class="input-label">Title</label>
              <input type="text" id="edit-note-title" class="input" value="${escapeHtml(note.title || '')}" placeholder="Enter note title">
            </div>
            <div class="input-group">
              <label for="edit-note-content" class="input-label">Content</label>
              <textarea id="edit-note-content" class="input textarea" placeholder="Write your note here..." rows="8">${escapeHtml(note.content || '')}</textarea>
            </div>
            <div class="input-group">
              <label for="edit-note-tags" class="input-label">Tags</label>
              <input type="text" id="edit-note-tags" class="input" value="${note.tags ? note.tags.join(', ') : ''}" placeholder="Enter tags separated by commas">
            </div>
          </form>
        `;
        
        footer.style.display = 'flex';
        footer.innerHTML = `
          <button class="btn btn-ghost" onclick="hideModal()">Cancel</button>
          <button class="btn btn-primary" onclick="updateNote(${id})">Update Note</button>
        `;
        
        showModal();
        document.getElementById('edit-note-title').focus();
        
      } catch (error) {
        handleError('Failed to load note for editing', error);
      }
    }
    
    async function updateNote(id) {
      const title = document.getElementById('edit-note-title').value.trim();
      const content = document.getElementById('edit-note-content').value.trim();
      const tags = document.getElementById('edit-note-tags').value.trim();
      
      if (!content) {
        showToast('Please enter some content for your note', 'error');
        return;
      }
      
      try {
        const note = await dbGet('notes', id);
        const updatedNote = {
          ...note,
          title: title || 'Untitled',
          content,
          tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
          wordCount: content.split(/\s+/).length,
          characterCount: content.length
        };
        
        await dbUpdate('notes', updatedNote);
        hideModal();
        showToast('Note updated successfully!', 'success');
        
        if (app.currentSection === 'notes') {
          loadSection('notes');
        }
        
      } catch (error) {
        handleError('Failed to update note', error);
      }
    }
    
    async function deleteNote(id) {
      if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
      }
      
      try {
        await dbDelete('notes', id);
        showToast('Note deleted successfully', 'success', {
          text: 'Undo',
          callback: () => {
            // TODO: Implement undo functionality
            showToast('Undo functionality coming soon', 'info');
          }
        });
        
        if (app.currentSection === 'notes') {
          loadSection('notes');
        }
        
      } catch (error) {
        handleError('Failed to delete note', error);
      }
    }
    
    // Similar CRUD operations for bookmarks, Arduino projects, etc.
    // ... (These would follow the same patterns as the note operations)
    
    // ======================
    // EXPORT/IMPORT
    // ======================
    
    async function exportData(format) {
      try {
        showToast('Preparing export...', 'info');
        
        const data = await gatherAllData();
        let blob, filename;
        
        switch (format) {
          case 'json':
            blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            filename = `moomin-hub-backup-${new Date().toISOString().slice(0, 10)}.json`;
            break;
            
          case 'zip':
           if (typeof JSZip === 'undefined') {
  showToast('ZIP export requires JSZip library', 'error');
  return;
}

const zip = new JSZip();
zip.file('data.json', JSON.stringify(data, null, 2));

// Export Notes as .txt files
if (data.notes && data.notes.length > 0) {
  const notesFolder = zip.folder('notes');
  data.notes.forEach(note => {
    notesFolder.file(
      `${note.id}-${sanitizeFilename(note.title || 'untitled')}.txt`,
      note.content || ''
    );
  });
}

// Export Gallery Images as real image files
if (data.gallery && data.gallery.length > 0) {
  const imagesFolder = zip.folder('gallery');
  data.gallery.forEach(image => {
    if (image.dataUrl) {
      try {
        // Split the data URL (e.g. "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQE...")
        const arr = image.dataUrl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1]; // Extract MIME type
        const bstr = atob(arr[1]); // Decode Base64
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime }); // Create real image blob

        // Use original filename or fallback
        const fileName = image.filename || `${image.id}.jpg`;
        imagesFolder.file(fileName, blob);
      } catch (err) {
        console.warn(`Failed to export image ${image.id}:`, err);
      }
    }
  });
}

// Export Arduino Projects as .ino files
if (data.arduino && data.arduino.length > 0) {
  const arduinoFolder = zip.folder('arduino');
  data.arduino.forEach(project => {
    if (project.code) {
      arduinoFolder.file(
        `${sanitizeFilename(project.title || 'untitled')}.ino`,
        project.code
      );
    }
  });
}

blob = await zip.generateAsync({ type: 'blob' });
filename = `moomin-hub-backup-${new Date().toISOString().slice(0, 10)}.zip`;
break;
            
          case 'encrypted':
            const password = prompt('Enter a password to encrypt your backup:');
            if (!password) return;
            
            const encrypted = await encryptData(JSON.stringify(data), password);
            blob = new Blob([JSON.stringify(encrypted, null, 2)], { type: 'application/json' });
            filename = `moomin-hub-encrypted-${new Date().toISOString().slice(0, 10)}.json`;
            break;
            
          default:
            throw new Error('Unsupported export format');
        }
        
        downloadBlob(blob, filename);
        // also attempt to save the export to the linked local folder (if any)
try {
  const dirHandle = app.localFolderHandle || await getSetting('localFolderHandle', null);
  if (dirHandle) {
    const canWrite = await verifyPermission(dirHandle, true);
    if (canWrite) {
      await writeFileToFolder(dirHandle, filename, blob);
      showToast('Also saved export to linked folder', 'success');
    } else {
      console.warn('No write permission for linked folder.');
    }
  }
} catch (err) {
  console.warn('Failed to save export to linked folder:', err);
}

        showToast('Export completed successfully!', 'success');
        
      } catch (error) {
        handleError('Export failed', error);
      }
    }
    
    async function gatherAllData() {
      const data = {
        meta: {
          app: APP_CONFIG.name,
          version: APP_CONFIG.version,
          exportedAt: new Date().toISOString(),
          encrypted: false
        }
      };
      
      // Gather data from all stores except settings (for privacy)
      for (const storeName of APP_CONFIG.stores) {
        if (storeName === 'settings') continue;
        data[storeName] = await dbGetAll(storeName);
      }
      
      // Include safe settings
      const safeSettings = await getSafeSettings();
      data.settings = safeSettings;
      
      return data;
    }
    
    async function getSafeSettings() {
      // Return settings that are safe to export (no passwords)
      const safeSettings = {};
      const settingsToExport = ['theme', 'pomodoroSettings'];
      
      for (const key of settingsToExport) {
        const value = await getSetting(key);
        if (value !== null) {
          safeSettings[key] = value;
        }
      }
      
      return safeSettings;
    }
    
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      urlCleanupSet.add(url);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Clean up the URL after a delay
      setTimeout(() => {
        URL.revokeObjectURL(url);
        urlCleanupSet.delete(url);
      }, 1000);
    }
    
    function sanitizeFilename(filename) {
      return filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    }
    
    // ======================
    // INITIALIZATION COMPLETE
    // ======================
    
    // ----------------------
// Local Folder Sync (File System Access API)
// ----------------------
async function verifyPermission(handle, withWrite = false) {
  if (!handle) return false;
  // new permission API: queryPermission / requestPermission
  try {
    const opts = withWrite ? { mode: 'readwrite' } : {};
    if (typeof handle.queryPermission === 'function') {
      let perm = await handle.queryPermission(opts);
      if (perm === 'granted') return true;
      perm = await handle.requestPermission(opts);
      return perm === 'granted';
    }
    if (typeof handle.requestPermission === 'function') {
      const perm = await handle.requestPermission(opts);
      return perm === 'granted';
    }
  } catch (e) {
    console.warn('Permission check failed', e);
  }
  // If API missing, assume it's allowed (best-effort)
  return true;
}

async function writeFileToFolder(dirHandle, filename, blob) {
  if (!dirHandle) throw new Error('No directory handle provided');
  const safeName = sanitizeFilename(filename);
  const fileHandle = await dirHandle.getFileHandle(safeName, { create: true });
  const writable = await fileHandle.createWritable();
  await writable.write(blob);
  await writable.close();
}

async function linkLocalFolder() {
  try {
    // toggle/unlink if already linked
    if (app.localFolderHandle) {
      if (!confirm('Unlink local folder? This will stop automatic backups (files already saved will remain on disk).')) return;
      await setSetting('localFolderHandle', null);
      app.localFolderHandle = null;
      updateFolderStatusUI();
      showToast('Local folder unlinked', 'success');
      return;
    }

    if (typeof window.showDirectoryPicker !== 'function') {
      showToast('Linking local folder requires a Chromium browser (Chrome / Edge) and secure context (https or localhost).', 'error');
      return;
    }

    const dirHandle = await window.showDirectoryPicker();
    if (!dirHandle) return;

    const ok = await verifyPermission(dirHandle, true);
    if (!ok) {
      showToast('Write permission is required to link this folder.', 'error');
      return;
    }

    await setSetting('localFolderHandle', dirHandle);
    app.localFolderHandle = dirHandle;
    updateFolderStatusUI();
    showToast('Local folder linked successfully', 'success');
  } catch (err) {
    handleError('Failed to link local folder', err);
  }
}

async function loadLinkedFolderOnStartup() {
  try {
    const stored = await getSetting('localFolderHandle', null);
    if (!stored) return;
    // try to restore permission state; if denied, we still keep the handle and will ask on write
    try {
      await verifyPermission(stored, false);
    } catch (e) {
      console.warn('Stored folder permission check failed', e);
    }
    app.localFolderHandle = stored;
    updateFolderStatusUI();
  } catch (e) {
    console.warn('loadLinkedFolderOnStartup failed', e);
  }
}

function updateFolderStatusUI() {
  const el = document.getElementById('folder-status');
  if (!el) return;
  const btn = document.querySelector('button[onclick="linkLocalFolder()"]');
  if (app.localFolderHandle) {
    const name = app.localFolderHandle.name || 'Linked folder';
    el.innerHTML = `<div class="font-medium">Status: Linked (${escapeHtml(name)})</div><div class="text-sm text-muted">Automatic backup enabled</div>`;
    if (btn) btn.textContent = 'Unlink Local Folder';
  } else {
    el.innerHTML = `<div class="font-medium">Status: Not linked</div><div class="text-sm text-muted">Link a folder to enable automatic backup</div>`;
    if (btn) btn.textContent = 'Link Local Folder';
  }
}

// expose so onclick in HTML can call it
window.linkLocalFolder = linkLocalFolder;
window.loadLinkedFolderOnStartup = loadLinkedFolderOnStartup;

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
    
    // ----------------------
// Local Folder Sync (subfolder-aware) - paste this BEFORE
// the "// Add to global scope for onclick handlers" comment
// ----------------------
/* eslint-disable */
window.app = window.app || {};

// provide a sanitizeFilename if your app doesn't already have one
if (typeof sanitizeFilename !== 'function') {
  window.sanitizeFilename = function(name) {
    return String(name)
      .replace(/[/\\?%*:|"<>]/g, '-')   // remove illegal chars
      .replace(/\s+/g, '_')            // spaces -> underscores
      .replace(/_+/g, '_')             // collapse repeated underscores
      .substring(0, 240);              // keep name length reasonable
  };
}

async function verifyPermission(handle, withWrite = false) {
  if (!handle) return false;
  try {
    const opts = withWrite ? { mode: 'readwrite' } : {};
    if (typeof handle.queryPermission === 'function') {
      let perm = await handle.queryPermission(opts);
      if (perm === 'granted') return true;
      perm = await handle.requestPermission(opts);
      return perm === 'granted';
    }
    if (typeof handle.requestPermission === 'function') {
      const perm = await handle.requestPermission(opts);
      return perm === 'granted';
    }
  } catch (e) {
    console.warn('Permission check failed', e);
  }
  // best-effort fallback
  return true;
}

// writeFileToFolder(dirHandle, "notes/note-1.json", blob)
async function writeFileToFolder(dirHandle, path, blob) {
  if (!dirHandle) throw new Error('No directory handle provided');

  // split path into folders + filename
  const parts = path.split('/').filter(p => p && p.trim());
  if (parts.length === 0) throw new Error('Invalid path');

  let currentDir = dirHandle;
  for (let i = 0; i < parts.length - 1; i++) {
    // create subfolder if missing
    currentDir = await currentDir.getDirectoryHandle(parts[i], { create: true });
  }

  const fileName = sanitizeFilename(parts[parts.length - 1]);
  const fileHandle = await currentDir.getFileHandle(fileName, { create: true });
  const writable = await fileHandle.createWritable();
  await writable.write(blob);
  await writable.close();
}

async function linkLocalFolder() {
  try {
    // toggle/unlink if already linked
    if (app.localFolderHandle) {
      if (!confirm('Unlink local folder? Files already saved will remain on disk.')) return;
      app.localFolderHandle = null;
      updateFolderStatusUI();
      showToast && showToast('Local folder unlinked', 'success');
      return;
    }

    if (typeof window.showDirectoryPicker !== 'function') {
      showToast && showToast('This feature requires Chrome/Edge and HTTPS (or localhost).', 'error');
      return;
    }

    const dirHandle = await window.showDirectoryPicker();
    if (!dirHandle) return;

    const ok = await verifyPermission(dirHandle, true);
    if (!ok) {
      showToast && showToast('Write permission is required.', 'error');
      return;
    }

    app.localFolderHandle = dirHandle;
    updateFolderStatusUI();
    showToast && showToast('Local folder linked successfully', 'success');
  } catch (err) {
    console.error('Failed to link local folder:', err);
    handleError && handleError('Failed to link local folder', err);
  }
}

function loadLinkedFolderOnStartup() {
  // Safe option: do not auto-restore handles across reloads.
  // This keeps behavior simple ‚Äî user must re-link after refresh.
  app.localFolderHandle = null;
  updateFolderStatusUI();
}

function updateFolderStatusUI() {
  const el = document.getElementById('folder-status');
  if (!el) return;
  const btn = document.querySelector('button[onclick="linkLocalFolder()"]');
  if (app.localFolderHandle) {
    const name = app.localFolderHandle.name || 'Linked folder';
    el.innerHTML = `<div class="font-medium">Status: Linked (${escapeHtml ? escapeHtml(name) : name})</div><div class="text-sm text-muted">Automatic backup enabled</div>`;
    if (btn) btn.textContent = 'Unlink Local Folder';
  } else {
    el.innerHTML = `<div class="font-medium">Status: Not linked</div><div class="text-sm text-muted">Link a folder to enable automatic backup</div>`;
    if (btn) btn.textContent = 'Link Local Folder';
  }
}
function sanitizeFilename(filename) {
  return filename.replace(/[/\\?%*:|"<>]/g, '-').replace(/\s+/g, '_');
}

// expose functions so other code can call them
window.verifyPermission = verifyPermission;
window.writeFileToFolder = writeFileToFolder;
window.linkLocalFolder = linkLocalFolder;
window.loadLinkedFolderOnStartup = loadLinkedFolderOnStartup;
/* eslint-enable */

    // Add to global scope for onclick handlers
    async function testSingleImageExport() {
  const images = await dbGetAll('gallery');
  if (!images.length) {
    alert('No images found!');
    return;
  }

  const image = images[0];
  const arr = image.dataUrl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  const blob = new Blob([u8arr], { type: mime });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = image.filename || 'test.jpg';
  a.click();
  URL.revokeObjectURL(a.href);
}

async function importData() {
  const fileInput = document.getElementById('import-file');
  const file = fileInput.files[0];

  if (!file) {
    showToast('Please select a backup file to import', 'error');
    return;
  }

  try {
    const text = await file.text();
    const data = JSON.parse(text);

    // Validate structure
    if (!data || !data.meta || data.meta.app !== 'MOOMIN Digital Hub') {
      showToast('Invalid backup file format', 'error');
      return;
    }

    showToast('Importing data...', 'info');

    // Import each section if it exists
    if (data.notes && Array.isArray(data.notes)) {
      for (const note of data.notes) {
        await dbAdd('notes', note);
      }
    }

    if (data.bookmarks && Array.isArray(data.bookmarks)) {
      for (const bookmark of data.bookmarks) {
        await dbAdd('bookmarks', bookmark);
      }
    }

    if (data.arduino && Array.isArray(data.arduino)) {
      for (const project of data.arduino) {
        await dbAdd('arduino', project);
      }
    }

    if (data.gallery && Array.isArray(data.gallery)) {
      for (const image of data.gallery) {
        await dbAdd('gallery', image);
      }
    }

    // Import safe settings
    if (data.settings) {
      for (const [key, value] of Object.entries(data.settings)) {
        await setSetting(key, value);
      }
    }

    showToast('‚úÖ Import completed successfully!', 'success');

    // Refresh current section and counts
    await updateNavigationCounts();
    await initializeSearch();
    loadSection(app.currentSection); // reload current view

    // Clear file input
    fileInput.value = '';

  } catch (error) {
    console.error('Import failed:', error);
    showToast('‚ùå Failed to import backup: ' + (error.message || 'Unknown error'), 'error');
  }
}

    window.openNewNoteModal = openNewNoteModal;
    window.openNewBookmarkModal = openNewBookmarkModal;
    window.openNewArduinoModal = openNewArduinoModal;
    window.triggerFileUpload = triggerFileUpload;
    window.saveNote = saveNote;
    window.saveBookmark = saveBookmark;
    window.saveArduinoProject = saveArduinoProject;
    window.viewNote = viewNote;
    window.editNote = editNote;
    window.updateNote = updateNote;
    window.deleteNote = deleteNote;
    window.loadSection = loadSection;
    window.hideModal = hideModal;
    window.exportData = exportData;
    window.setTheme = setTheme;
    window.linkLocalFolder = linkLocalFolder;
    window.loadLinkedFolderOnStartup = loadLinkedFolderOnStartup;
    window.importData = importData;


  </script>
</body>
</html>
